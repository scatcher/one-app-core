angular.module("spAngular").directive("oaAttachments",function(a,b){return{restrict:"A",replace:!0,templateUrl:"src/scripts/directives/oa_attachments/oa_attachments_tmpl.html",scope:{listItem:"=",changeEvent:"="},link:function(c,d){function e(){_.isFunction(c.changeEvent)&&c.changeEvent(),d.find("iframe").attr("src",d.find("iframe").attr("src"))}c.attachments=[],c.state={ready:!1},c.refresh=function(){c.$$phase||c.$apply()};var f=c.listItem.getModel(),g=f.list.webURL+"/_layouts/Attachfile.aspx?ListId="+f.list.guid+"&ItemId="+c.listItem.id+"&IsDlg=1";c.trustedUrl=a.trustAsResourceUrl(g);var h=function(){b.info("Checking for attachments"),c.listItem.getAttachmentCollection().then(function(a){c.attachments.length=0,Array.prototype.push.apply(c.attachments,a)})};h(),c.fileName=function(a){var b=a.lastIndexOf("/")+1;return a.substr(b)},c.deleteAttachment=function(a){var d=window.confirm("Are you sure you want to delete this file?");d&&(b.info("Negotiating with the server"),c.listItem.deleteAttachment(a).then(function(){b.success("Attachment successfully deleted"),h(),_.isFunction(c.changeEvent)&&c.changeEvent()}))},d.find("iframe").bind("load",function(){c.state.ready=!0,c.refresh();var a=$(this).contents();a.find("#CancelButton").length<1?(b.success("File successfully uploaded"),e(),h(),_.isFunction(c.changeEvent)&&c.changeEvent()):(a.find("#CancelButton").hide(),a.find(".ms-dialog").css({height:"95px"}),a.find("input[name$='Ok']").css({"float":"left"}).click(function(){b.info("Please wait while the file is uploaded")}),a.find("input[name$='$InputFile']").attr({size:40}),a.find("#s4-workspace").css({"overflow-y":"hidden","overflow-x":"hidden"}),console.log("Frame Loaded"))})}}}),angular.module("spAngular").directive("oaComments",function(a,b,c,d,e){return{restrict:"A",replace:!0,templateUrl:"src/scripts/directives/oa_comments/oa_comments_tmpl.html",scope:{listItem:"=",changeEvent:"="},link:function(a){a.state={ready:!1,tempComment:"",tempResponse:"",respondingTo:""},a.comments=a.listItem.comments||null,a.refresh=function(){a.$$phase||a.$apply()},a.clearTempVars=function(){b(function(){a.state.respondingTo="",a.state.tempResponse="",a.state.tempComment=""})},a.createNewComment=function(){e.info("Negotiating with the server"),a.comments?a.comments.createResponse(a.state.tempComment).then(function(b){a.comments=b,a.clearTempVars()}):c.createComment(a.listItem,a.state.tempComment).then(function(b){a.comments=b,a.clearTempVars()})},a.createResponse=function(b){e.info("Negotiating with the server"),b.createResponse(a.state.tempResponse).then(function(){a.clearTempVars()})},a.deleteComment=function(b){var c=b.parentComment(),d=b.rootComment(),f=window.confirm("Are you sure you want to delete this comment?");return f?(e.info("Negotiating with the server"),c===d&&1===c.thread.length?d.deleteItem().then(function(){delete a.comments,delete a.listItem.comments,e.success("Comment successfully deleted")},function(){e.error("There was a problem deleting this comment.  Please try again.")}):d.saveChanges().then(function(){var a=c.thread.indexOf(b);c.thread.splice(a,1),e.success("Comment successfully deleted")},function(){e.error("There was a problem deleting this comment.  Please try again.")})):void 0};var f=function(){e.info("Checking for new comments"),a.listItem.fetchComments().then(function(c){b(function(){d.offline&&!a.listItem.comments?a.comments=c[0]:c.length>0&&(a.comments=c[0]),a.listItem.comments=a.comments,a.state.ready=!0})})};f(),c.sync.subscribeToChanges(function(){console.log("Comment change detected")})}}}),angular.module("spAngular").directive("oaSelect",function(){return{restrict:"A",replace:!0,templateUrl:"src/scripts/directives/oa_select/oa_select_tmpl.html",scope:{bindedField:"=",multi:"=",arr:"=",lookupValue:"=",ngDisabled:"="},link:function(a){a.state={multiSelectIDs:[],singleSelectID:""},a.state.lookupField=a.lookupValue||"title";var b=function(b){var c=parseInt(b,10),d=_.findWhere(a.arr,{id:c});return{lookupId:c,lookupValue:d[a.state.lookupField]}};a.generateDisplayText=function(b){return _.isFunction(a.state.lookupField)?a.state.lookupField(b):_.isString(a.state.lookupField)?b[a.state.lookupField]:b.title},a.updateMultiModel=function(){_.isArray(a.bindedField)||(a.bindedField=[]),a.bindedField.length=0,_.each(a.state.multiSelectIDs,function(c){a.bindedField.push(b(c))})},a.updateSingleModel=function(){a.bindedField=b(a.state.singleSelectID)},a.$watch("bindedField",function(){a.multi?_.each(a.bindedField,function(b){a.state.multiSelectIDs.push(b.lookupId.toString())}):_.isObject(a.bindedField)&&a.bindedField.lookupId&&(a.state.singleSelectID=a.bindedField.lookupId)})}}}),angular.module("spAngular").run(["$templateCache",function(a){"use strict";a.put("src/scripts/directives/oa_attachments/oa_attachments_tmpl.html",'<div style="min-height: 200px;">\n\n    <div class="row">\n        <div class="col-xs-12">\n            <div ng-hide="state.ready" class="alert alert-info">Loading attachment details</div>\n            <div style="height: 110px;" ng-show="state.ready">\n                <h4>\n                    <small>Add Attachment</small>\n                </h4>\n                <iframe frameborder="0" seamless="seamless" width="100%" src="{{ trustedUrl }}"\n                        scrolling="no" style="height: 95px"></iframe>\n            </div>\n        </div>\n    </div>\n\n    <h4 ng-show="attachments.length > 0">\n        <small>Attachments</small>\n    </h4>\n\n    <ul class="list-unstyled">\n        <li ng-repeat="attachment in attachments">\n            <a href="{{ attachment }}" target="_blank">{{ fileName(attachment) }}</a>\n            <button class="btn btn-link" ng-click="deleteAttachment(attachment)" title="Delete this attachment">\n                <i class="fa fa-times red"></i>\n            </button>\n        </li>\n    </ul>\n\n</div>'),a.put("src/scripts/directives/oa_comments/oa_comments_tmpl.html",'<div>\n    <div class="pull-right">\n        <button class="btn btn-primary btn-xs" ng-click="createNewComment()"\n                title="Create a new comment"\n                ng-show="state.tempComment.length > 0">Save\n        </button>\n        <button class="btn btn-default btn-xs" ng-click="clearTempVars()"\n                title="Cancel comment"\n                ng-show="state.tempComment.length > 0">Cancel\n        </button>\n        <!--<button class="btn btn-link btn-xs" title="Toggle the new comment form"-->\n        <!--ng-click="state.newCommentVisible = !state.newCommentVisible">-->\n        <!--<i class="fa fa-comment"></i> Create-->\n        <!--</button>-->\n    </div>\n    <div style="min-height: 150px;">\n        <div class="newComment">\n            <div class="form-group">\n                <h4><small>New Comment</small></h4>\n                <textarea class="form-control" rows="2" ng-model="state.tempComment" placeholder="Create a new comment..."></textarea>\n            </div>\n        </div>\n        <div class="alert text-center" style="margin-top: 30px;" ng-show="!state.ready">\n            <h4><small>loading...</small></h4>\n        </div>\n        <div class="grey" style="margin-top: 30px;" ng-show="!comments && !state.newCommentVisible && state.ready">\n            No comments have been made. Create one using the input box above.\n        </div>\n        <div ng-if="comments && comments.thread.length > 0" class="comments-container">\n            <span ng-include="\'src/scripts/directives/oa_comments/recursive_comment.html\'"\n                  ng-init="comment = comments;"></span>\n        </div>\n    </div>\n</div>'),a.put("src/scripts/directives/oa_comments/recursive_comment.html",'<ul class="comments">\n    <li class="comment" ng-repeat="response in comment.thread" style="border-top-width: 1px;border-top-color: grey">\n        <div class="comment-content">\n            <div class="content">\n                <h5>\n                    <small>\n                        <span class="author">{{ response.author.lookupValue }}</span>\n                        <span>{{ response.modified  | date:\'short\' }}</span>\n                        <button class="btn btn-link btn-xs" ng-click="state.respondingTo = response"><i\n                                class="fa fa-mail-reply"></i> Reply\n                        </button>\n                        <button class="btn btn-link btn-xs"\n                                ng-click="deleteComment(response)"><i\n                                class="fa fa-trash-o"></i> Delete\n                        </button>\n                    </small>\n                </h5>\n                <p class="comment-text">{{ response.comment }}</p>\n            </div>\n        </div>\n        <div ng-if="state.respondingTo === response">\n            <div class="row">\n                <div class="col-xs-12">\n                    <form>\n                        <div class="form-group">\n                            <h5>\n                                <small>\n                                    Response\n                                    <label class="pull-right">\n                                        <button class="btn btn-link btn-xs"\n                                                ng-click="createResponse(response)"><i\n                                                class="fa fa-save"></i> Save\n                                        </button>\n                                        <button class="btn btn-link btn-xs"\n                                                ng-click="clearTempVars()"><i class="fa fa-undo"></i> Cancel\n                                        </button>\n                                    </label>\n                                </small>\n                            </h5>\n                            <textarea class="form-control" rows="2"\n                                      ng-model="state.tempResponse"></textarea>\n                        </div>\n                    </form>\n                </div>\n            </div>\n        </div>\n        <div ng-if="response.thread.length !== -1">\n            <span ng-include="\'src/scripts/directives/oa_comments/recursive_comment.html\'"\n                  ng-init="comment = response;"></span>\n        </div>\n    </li>\n</ul>'),a.put("src/scripts/directives/oa_select/oa_select_tmpl.html",'<span class="ng-cloak">\n   <span ng-if="!multi">\n       <select class="form-control" ng-model="state.singleSelectID"\n               ng-change="updateSingleModel()" style="width: 100%" ng-disabled="ngDisabled"\n               ng-options="lookup.id as lookup[state.lookupField] for lookup in arr">\n       </select>\n   </span>\n   <span ng-if="multi">\n       <select multiple ui-select2 ng-model="state.multiSelectIDs"\n               ng-change="updateMultiModel()" style="width: 100%;" ng-disabled="ngDisabled">\n           <option></option>\n           <option ng-repeat="lookup in arr" value="{{ lookup.id }}"\n                   ng-bind="lookup[state.lookupField]">&nbsp;</option>\n       </select>\n   </span>\n</span>\n')}]);