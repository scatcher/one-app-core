"use strict";angular.module("spAngular",["ui.bootstrap","ui.router","ngTable","firebase","angularSpinner","toastr"]).config(["$stateProvider","$urlRouterProvider",function(){}]).run(function(){}),angular.module("spAngular").service("configService",["toastrConfig",function(a){a.positionClass="toast-bottom-right";var b=window.location.href.indexOf("localhost")>-1;return{appTitle:"SP-Angular",debugEnabled:!0,firebaseURL:"The url of your firebase source",offline:b}}]),angular.module("spAngular").service("dataService",["$q","$timeout","queueService","configService","utilityService","toastr",function(a,b,c,d,e,f){function g(a,b){var c=0,d=0,e=_.pluck(a,"id");return _.each(b,function(b){-1===e.indexOf(b.id)?(a.push(b),e.push(b.id),d++):(a[e.indexOf(b.id)]=b,c++)}),{created:d,updated:c}}function h(a,b){var c=[],d=$(a).find("Version").length;return $(a).find("Version").each(function(a){var f=this,g={editor:e.attrToJson($(f).attr("Editor"),"User"),modified:moment($(f).attr("Modified")).toDate(),version:d-a};g[b.mappedName]=e.attrToJson($(f).attr(b.internalName),b.objectType),c.unshift(g)}),c}function i(a,b){var c=!1,d=_.findWhere(a,{id:b}),e=_.indexOf(a,d);return e&&(a.splice(e,1),c=!0),c}function j(a){return $(a).find("Changes").attr("LastChangeToken")}function k(a){return $(a).find("listitems").attr("EffectivePermMask")}function l(a,b){var c=0;$(a).SPFilterNode("Id").each(function(){var a=$(this).attr("ChangeType");if("Delete"===a){var d=parseInt($(this).text(),10),e=i(b,d);e&&c++}}),c>0&&p&&console.log(c+" item(s) removed from local cache to mirror changes on source list.")}function m(a,b){var c="";return _.each(a,function(d,e){c+=d[b],e<a.length&&(c+=";#;#")}),c}function n(a,b){var c=[];return _.each(a,function(a){_.has(b,a.mappedName)&&c.push(z(a,b[a.mappedName]))}),c}var o={},p=window.location.href.indexOf("localhost")>-1,q=d.defaultUrl||$().SPServices.SPGetCurrentSite(),r=function(a,b,d){c.decrease();var f={factory:a.factory,filter:"z:row",mapping:a.list.mapping,mode:"update",target:a.getCache()},h=_.extend({},f,d),i=$(b).SPFilterNode(h.filter),j=e.xmlToJson(i,{mapping:h.mapping}),k=[];if(_.each(j,function(b){b.getQuery=h.getQuery,b.getContainer=function(){return h.target},k.push(new a.factory(b))}),"replace"===h.mode)h.target=k,p&&console.log(a.list.title+" Replaced with "+h.target.length+" new records.");else if("update"===h.mode){var l=g(h.target,k);p&&console.log(a.list.title+" Changes (Create: "+l.created+" | Update: "+l.updated+")")}return k},s=function(c,d){var e=a.defer();if(p)b(function(){e.resolve([])});else{var g=$().SPServices(c);g.then(function(){var a=h(g.responseText,d);e.resolve(a)},function(a){f.error("Failed to fetch version history."),e.reject(a)})}return e.promise},t=function(b){c.increase();var d={webURL:q},e=_.extend({},d,b),g=e.filterNode||e.operation.split("Get")[1].split("Collection")[0],h=a.defer(),i=function(a){var b=[];return"GetAttachmentCollection"===e.operation?$(a).SPFilterNode(g).each(function(){b.push($(this).text())}):b=$(a).SPFilterNode(g).SPXmlToJson({includeAllAttrs:!0,removeOws:!1}),b};if(p){var j="dev/"+e.operation+".xml";$.ajax(j).then(function(a){c.decrease(),h.resolve(i(a))},function(a){f.error("You need to have a dev/"+e.operation+".xml in order to get the group collection in offline mode."),h.reject(a),c.decrease()})}else{var k=!0,l={};_.extend(l,e);var m=function(a){_.each(a,function(a){l[a]||(f.error("options"+a+" is required to complete this operation"),k=!1,h.reject([]))})};switch(e.operation){case"GetGroupCollectionFromUser":m(["userLoginName"]);break;case"GetUserCollectionFromGroup":m(["groupName"]);break;case"GetViewCollection":m(["listName"]);break;case"GetAttachmentCollection":m(["listName","ID"])}if(k){var n=$().SPServices(l);n.then(function(){c.decrease(),h.resolve(i(n.responseXML))},function(a){f.error("Failed to fetch list collection."),c.decrease(),h.reject(a)})}}return h.promise},u=function(b){var d={webURL:q},e=_.extend({},d,b),g=a.defer();c.increase();var h=function(a){return e.filterNode?$(a).SPFilterNode(e.filterNode).SPXmlToJson({includeAllAttrs:!0,removeOws:!1}):a};if(p){var i="dev/"+e.operation+".xml";$.ajax(i).then(function(a){c.decrease(),g.resolve(h(a))},function(a){f.error("You need to have a dev/"+e.operation+".xml in order to get the group collection in offline mode."),g.reject(a),c.decrease()})}else{var j={};_.extend(j,e);var k=$().SPServices(j);k.then(function(){c.decrease(),g.resolve(h(k.responseXML))},function(a){f.error("Failed to fetch list collection."),c.decrease(),g.reject(a)})}return g.promise},v=function(b){var d=_.extend({},b);c.increase();var e=a.defer(),g=$().SPServices({operation:"GetList",listName:d.listName});return g.then(function(){c.decrease();var a=$(g.responseXML).SPFilterNode("Field").SPXmlToJson({includeAllAttrs:!0,removeOws:!1});e.resolve(a)},function(a){e.reject(a),f.error("Failed to fetch list details.")}).always(function(){c.decrease()}),e.promise},w=function(b){var d=_.extend({},b);c.increase();var e=a.defer(),g=$().SPServices({operation:"DeleteAttachment",listItemID:d.listItemId,url:d.url,listName:d.listName});return g.then(function(){c.decrease();var a=$(g.responseXML).SPFilterNode("Field").SPXmlToJson({includeAllAttrs:!0,removeOws:!1});e.resolve(a)},function(a){e.reject(a),f.error("Failed to fetch list details.")}).always(function(){c.decrease()}),e.promise},x=function(b){var d=_.extend({},b),e=a.defer();c.increase();var g={operation:"GetView",listName:d.listName};d.viewName&&(g.viewName=d.viewName);var h=$().SPServices(g);return h.then(function(){var a={query:"<Query>"+$(h.responseText).find("Query").html()+"</Query>",viewFields:"<ViewFields>"+$(h.responseText).find("ViewFields").html()+"</ViewFields>",rowLimit:$(h.responseText).find("RowLimit").html()};e.resolve(a)},function(a){f.error("Failed to fetch view details."),e.reject(a)}).always(function(){c.decrease()}),e.promise},y=function(b,d,e){var g={target:b.getCache()},h=a.defer(),i=_.extend({},g,e);if(i.getQuery=function(){return d},c.increase(),p){var m=i.offlineXML||d.offlineXML||"dev/"+b.list.title+".xml";d.lastRun?(d.lastRun=new Date,c.decrease(),h.resolve(d.cache)):$.ajax(m).then(function(a){var e=r(b,a,i);d.lastRun=new Date,c.decrease(),h.resolve(e)},function(){var a=b.generateMockData();h.resolve(a),f.error('There was a problem locating the "dev/'+b.list.title+'.xml"')})}else{var n=$().SPServices(d);n.then(function(){var a=n.responseXML;if("GetListItemChangesSinceToken"===d.operation){d.changeToken=j(a);var e=k(a);e&&(b.list.effectivePermMask=e),l(a,i.target)}var f=r(b,a,i);d.lastRun=new Date,c.decrease(),h.resolve(f)})}return h.promise},z=function(a,b){var c=[],d=a.internalName;if(b&&""!==b){switch(a.objectType){case"Lookup":case"User":c=b.lookupId?[d,b.lookupId]:[d,""];break;case"LookupMulti":case"UserMulti":var e=m(b,"lookupId");c=[a.internalName,e];break;case"Boolean":c=[d,b?1:0];break;case"DateTime":c=moment(b).isValid()?[d,moment(b).format("YYYY-MM-DDTHH:mm:ss[Z]Z")]:[d,""];break;case"Note":case"HTML":c=[d,_.escape(b)];break;case"JSON":c=[d,angular.toJson(b)];break;default:c=[d,b]}p&&console.log("{"+a.objectType+"} "+c)}else c=[d,""];return c},A=function(b,d,e){var g={mode:"update",buildValuePairs:!0,valuePairs:[]},h=a.defer(),i=_.extend({},g,e);if(c.increase(),i.buildValuePairs===!0){var j=_.where(b.list.fields,{readOnly:!1});i.valuePairs=n(j,d)}var k={operation:"UpdateListItems",webURL:b.list.webURL,listName:b.list.guid,valuepairs:i.valuePairs};if(_.isObject(d)&&_.isNumber(d.id)?(k.batchCmd="Update",k.ID=d.id):k.batchCmd="New",p){window.console.log(k);var l={modified:new Date,editor:{lookupId:23,lookupValue:"Generic User"}};if(d.id)_.extend(d,l),h.resolve(d);else{var m;l.author={lookupId:23,lookupValue:"Generic User"},l.created=new Date,_.each(b.queries,function(a){var c=1;_.each(a.cache,function(a){a.id>c&&(c=a.id)}),l.id=c+1,_.extend(d,l),m=new b.factory(d),a.cache.push(m)}),h.resolve(m)}c.decrease()}else{var o=$().SPServices(k);o.then(function(){var a=r(b,o.responseXML,i);h.resolve(a[0])},function(a){f.error("There was an error getting the requested data from "+b.list.name),h.reject(a)}).always(function(){c.decrease()})}return h.promise},B=function(b,d,e){c.increase();var g={target:d.getContainer()},h=_.extend({},g,e),j={operation:"UpdateListItems",webURL:b.list.webURL,listName:b.list.guid,batchCmd:"Delete",ID:d.id},k=a.defer();if(p)i(h.target,d.id),c.decrease(),k.resolve(h.target);else{var l=$().SPServices(j);l.then(function(){i(h.target,d.id),c.decrease(),k.resolve(h.target)},function(a){f.error("There was an error deleting a list item from "+b.list.title),c.decrease(),k.reject(a)})}return k.promise};return _.extend(o,{addUpdateItemModel:A,createValuePair:z,deleteAttachment:w,deleteItemModel:B,generateValuePairs:n,getCollection:t,getFieldVersionHistory:s,getList:v,getView:x,executeQuery:y,processListItems:r,serviceWrapper:u}),o}]),angular.module("spAngular").service("fieldService",["utilityService",function(a){function b(){return chance.bool()}function c(){return chance.word()+" "+chance.word()}function d(){return chance.paragraph()}function e(){return parseInt(100*_.random(1e7,!0))/100}function f(){return chance.date()}function g(){return chance.integer()}function h(a){var b;switch(a){case"AddListItems":b="0x0000000000000002";break;case"EditListItems":b="0x0000000000000004";break;case"DeleteListItems":b="0x0000000000000008";break;case"ApproveItems":b="0x0000000000000010";break;case"FullMask":b="0x7FFFFFFFFFFFFFFF";break;case"ViewListItems":default:b="0x0000000000000001"}return b}function i(a){var b="FullMask";return a&&a.permissionLevel&&(b=a.permissionLevel),h(b)}function j(){return{lookupId:s(),lookupValue:chance.word()}}function k(){return{lookupId:s(),lookupValue:chance.name()}}function l(){var a=[];return _.each(_.random(10),function(){a.push(j())}),a}function m(){var a=[];return _.each(_.random(10),function(){a.push(k())}),a}function n(b){var c=this,d={readOnly:!1,objectType:"Text"};_.extend(c,d,b),c.displayName=c.displayName||a.fromCamelCase(c.mappedName)}function o(a){return t[a]}function p(a){var b,c=o(a);return c&&(b=c.defaultValue),b}function q(a,b){var c,d=o(a);return d&&(c=b&&b.staticValue?d.staticMock:d.dynamicMock(b)),c}function r(a){var b=function(b){var c=new n(b);a.fields.push(c),a.viewFields+='<FieldRef Name="'+c.internalName+'"/>',a.mapping["ows_"+c.internalName]={mappedName:c.mappedName,objectType:c.objectType}};a.viewFields+="<ViewFields>",_.each(u,function(a){b(a)}),_.each(a.customFields,function(a){b(a)}),a.viewFields+="</ViewFields>"}var s=function(){var a=s;return a.count=a.count||0,a.count++,a.count};n.prototype.getDefinition=function(){return o(this.objectType)},n.prototype.getDefaultValueForType=function(){return p(this.objectType)},n.prototype.getMockData=function(a){return q(this.objectType,a)};var t={Text:{defaultValue:"",staticMock:"Test String",dynamicMock:c},TextLong:{defaultValue:"",staticMock:"This is a sentence.",dynamicMock:d},Boolean:{defaultValue:null,staticMock:!0,dynamicMock:b},Counter:{defaultValue:null,staticMock:s(),dynamicMock:s},Currency:{defaultValue:null,staticMock:120.5,dynamicMock:e},DateTime:{defaultValue:null,staticMock:new Date(2014,5,4,11,33,25),dynamicMock:f},Integer:{defaultValue:null,staticMock:14,dynamicMock:g},JSON:{defaultValue:"",staticMock:[{id:1,title:"test"},{id:2}],dynamicMock:c},Lookup:{defaultValue:"",staticMock:{lookupId:49,lookupValue:"Static Lookup"},dynamicMock:j},LookupMulti:{defaultValue:[],staticMock:[{lookupId:50,lookupValue:"Static Multi 1"},{lookupId:51,lookupValue:"Static Multi 2"}],dynamicMock:l},Mask:{defaultValue:i(),staticMock:i(),dynamicMock:i},User:{defaultValue:"",staticMock:{lookupId:52,lookupValue:"Static User"},dynamicMock:k},UserMulti:{defaultValue:[],staticMock:[{lookupId:53,lookupValue:"Static User 1"},{lookupId:54,lookupValue:"Static User 2"}],dynamicMock:m}},u=[{internalName:"ID",objectType:"Counter",mappedName:"id",readOnly:!0},{internalName:"Modified",objectType:"DateTime",mappedName:"modified",readOnly:!0},{internalName:"Created",objectType:"DateTime",mappedName:"created",readOnly:!0},{internalName:"Author",objectType:"User",mappedName:"author",readOnly:!0},{internalName:"Editor",objectType:"User",mappedName:"editor",readOnly:!0},{internalName:"PermMask",objectType:"Mask",mappedName:"permMask",readOnly:!0}];return{defaultFields:u,extendFieldDefinitions:r,getDefaultValueForType:p,getMockData:q,getDefinition:o,mockPermMask:i,resolveValueForEffectivePermMask:h}}]),angular.module("spAngular").service("modalService",["$modal","toastr",function(a,b){function c(b){return function c(){var d=c,e={templateUrl:b.templateUrl,controller:b.controller,resolve:{}},f=_.extend({},e,b),g=arguments;_.each(b.expectedArguments,function(a,b){f.resolve[a]=function(){return g[b]}});var h=a.open(f);return g[0]&&(d.snapshot=angular.copy(g[0]),h.result.then(function(){},function(){_.extend(g[0],d.snapshot)})),h.result}}function d(a){var b={userCanEdit:!0,userCanDelete:!1,userCanApprove:!1,fullControl:!1};if(_.isObject(a)&&_.isFunction(a.resolvePermissions)){var c=a.resolvePermissions();b.userCanEdit=c.EditListItems,b.userCanDelete=c.DeleteListItems,b.userCanApprove=c.ApproveItems,b.fullControl=c.FullMask}return b}function e(a,b){var c={userCanEdit:!1,userCanDelete:!1,negotiatingWithServer:!1,locked:!1,lockedBy:"",displayMode:"View"},e=d(a);return a&&a.id?e.userCanEdit&&(c.displayMode="Edit"):c.displayMode="New",_.extend(c,e,b)}function f(a,c,d){var e=window.confirm("Are you sure you want to delete this record?");e&&(c.negotiatingWithServer=!0,a.deleteItem().then(function(){b.success("Record deleted successfully"),d.close()},function(){b.error("Failed to delete record.  Please try again.")}))}function g(a,c,d,e){a.id?a.saveChanges().then(function(){b.success("Record updated"),e.close()},function(){b.error("There was a problem updating this record.  Please try again.")}):c.addNewItem(a).then(function(){b.success("New record created"),e.close()},function(){b.error("There was a problem creating a new record.  Please try again.")})}return{deleteEntity:f,initializeState:e,modalModelProvider:c,getPermissions:d,saveEntity:g}}]),angular.module("spAngular").factory("modelFactory",["$q","$timeout","configService","dataService","fieldService","toastr",function(a,b,c,d,e,f){function g(a){var b=this,c={data:[],factory:n,lastServerUpdate:null,queries:{}};return _.extend(b,c,a),b.list=new j(b.list),b.factory.prototype=new i,b.factory.prototype.getModel=function(){return b},b}function h(a){!c.offline&&a.sync&&_.isFunction(a.sync.registerChange)&&a.sync.registerChange()}function i(){}function j(a){var b={viewFields:"",customFields:[],isReady:!1,fields:[],guid:"",mapping:{},title:"",webURL:c.defaultUrl},d=_.extend({},b,a);return e.extendFieldDefinitions(d),d}function k(b,d){var e=this,f={cache:[],initialized:a.defer(),lastRun:null,listName:d.list.guid,negotiatingWithServer:!1,operation:"GetListItemChangesSinceToken",query:'<Query>   <OrderBy>       <FieldRef Name="ID" Ascending="TRUE"/>   </OrderBy></Query>',queryOptions:"<QueryOptions>   <IncludeMandatoryColumns>FALSE</IncludeMandatoryColumns>   <IncludeAttachmentUrls>TRUE</IncludeAttachmentUrls>   <IncludeAttachmentVersion>FALSE</IncludeAttachmentVersion>   <ExpandUserField>FALSE</ExpandUserField></QueryOptions>",viewFields:d.list.viewFields,webURL:c.defaultUrl};_.extend(e,f,b);var g=[["query","CAMLQuery"],["viewFields","CAMLViewFields"],["rowLimit","CAMLRowLimit"],["queryOptions","CAMLQueryOptions"],["listItemID","ID"]];_.each(g,function(a){e[a[0]]&&!e[a[1]]&&(e[a[1]]=e[a[0]])}),e.getModel=function(){return d}}function l(a){var b={};return b.ViewListItems=(1&a)>0,b.AddListItems=(2&a)>0,b.EditListItems=(4&a)>0,b.DeleteListItems=(8&a)>0,b.ApproveItems=(16&a)>0,b.OpenItems=(32&a)>0,b.ViewVersions=(64&a)>0,b.DeleteVersions=(128&a)>0,b.CancelCheckout=(256&a)>0,b.PersonalViews=(512&a)>0,b.ManageLists=(2048&a)>0,b.ViewFormPages=(4096&a)>0,b.Open=(65536&a)>0,b.ViewPages=(131072&a)>0,b.AddAndCustomizePages=(262144&a)>0,b.ApplyThemeAndBorder=(524288&a)>0,b.ApplyStyleSheets=(1048576&a)>0,b.ViewUsageData=(2097152&a)>0,b.CreateSSCSite=(4194314&a)>0,b.ManageSubwebs=(8388608&a)>0,b.CreateGroups=(16777216&a)>0,b.ManagePermissions=(33554432&a)>0,b.BrowseDirectories=(67108864&a)>0,b.BrowseUserInfo=(134217728&a)>0,b.AddDelPrivateWebParts=(268435456&a)>0,b.UpdatePersonalWebParts=(536870912&a)>0,b.ManageWeb=(1073741824&a)>0,b.UseRemoteAPIs=(137438953472&a)>0,b.ManageAlerts=(274877906944&a)>0,b.CreateAlerts=(549755813888&a)>0,b.EditMyUserInfo=(1099511627776&a)>0,b.EnumeratePermissions=(0x4000000000000000&a)>0,b.FullMask=0x8000000000000000==a,b.FullMask&&_.each(b,function(a,c){b[c]=!0}),b}var m="primary",n=function(a){var b=this;_.extend(b,a)};return g.prototype.getAllListItems=function(){var b=a.defer();return d.executeQuery(this,this.queries.getAllListItems,{deferred:b}).then(function(a){b.resolve(a)}),b.promise()},g.prototype.addNewItem=function(b,c){var e=this,f=a.defer();return d.addUpdateItemModel(e,b,c).then(function(a){f.resolve(a),h(e)}),f.promise},g.prototype.registerQuery=function(a){var b=this,c={name:m};return a=_.extend({},c,a),b.queries[a.name]=new k(a,b),b.queries[a.name]},g.prototype.getQuery=function(a){var b,c=this;return b=_.isObject(c.queries[a])?c.queries[a]:_.isObject(c.queries[m])&&!a?c.queries[m]:void 0},g.prototype.getCache=function(a){var b,c,d=this;return b=d.getQuery(a),b&&b.cache&&(c=b.cache),c},g.prototype.executeQuery=function(a,b){var c=this,d=c.getQuery(a);return d?d.execute(b):void 0},g.prototype.isInitialised=function(){return _.isDate(this.lastServerUpdate)},g.prototype.searchLocalCache=function(a,b){var c,d=this,e=d.searchLocalCache,f={propertyPath:"id",localCache:d.getCache(),cacheName:"main",rebuildIndex:!1},g=_.extend({},f,b);e.indexCache=e.indexCache||{},e.indexCache[g.cacheName]=e.indexCache[g.cacheName]||{};var h=e.indexCache[g.cacheName],i=g.propertyPath.split(".");return _.each(i,function(a){h[a]=h[a]||{},h=h[a]}),h.map=h.map||[],(!_.isNumber(h.count)||h.count!==g.localCache.length||g.rebuildIndex)&&(h.map=_.deepPluck(g.localCache,g.propertyPath),h.count=g.localCache.length),_.isArray(a)?(c=[],_.each(a,function(a){c.push(g.localCache[h.map.indexOf(a)])})):c=g.localCache[h.map.indexOf(a)],c},g.prototype.createEmptyItem=function(a){var b=this,c={};_.each(b.list.customFields,function(a){a.readOnly||(c[a.mappedName]=e.getDefaultValueForType(a.objectType))});var d=_.extend({},c,a);return new b.factory(d)},g.prototype.generateMockData=function(a){var b=[],c=this,d={quantity:10,staticValue:!1,permissionLevel:"FullMask"},e=_.extend({},d,a);return _.times(e.quantity,function(){var a={};_.each(c.list.fields,function(b){a[b.mappedName]=b.getMockData(e)}),b.push(new c.factory(a))}),b},g.prototype.validateEntity=function(a,b){var c=!0,d=this,e={toast:!0},g=_.extend({},e,b),h=function(a){return _.isObject(a)&&_.isNumber(a.lookupId)};return _.each(d.list.customFields,function(b){var d=a[b.mappedName],e='"'+b.objectType+'" value.';if(b.required&&c){switch(b.objectType){case"DateTime":c=_.isDate(d);break;case"Lookup":case"User":c=h(d);break;case"LookupMulti":case"UserMulti":c=_.isArray(d)&&d.length>0,c&&_.each(d,function(a){return c?void(c=h(a)):!1});break;default:c=!_.isEmpty(d)}if(!c&&g.toast){var i=b.label||b.internalName;f.error(i+" does not appear to be a valid "+e)}}return c?void 0:!1}),c},i.prototype.getDataService=function(){return d},i.prototype.saveChanges=function(b){var c=this,e=c.getModel(),f=a.defer();return d.addUpdateItemModel(e,c,b).then(function(a){f.resolve(a),h(e)}),f.promise},i.prototype.saveFields=function(b){var c=this,e=c.getModel(),f=a.defer(),g=[];_.each(b,function(a){var b=_.findWhere(e.list.customFields,{mappedName:a});b&&g.push(b)});var i=d.generateValuePairs(g,c);return d.addUpdateItemModel(e,c,{buildValuePairs:!1,valuePairs:i}).then(function(a){f.resolve(a),h(e)}),f.promise},i.prototype.deleteItem=function(b){var c=this,e=c.getModel(),f=a.defer();return d.deleteItemModel(e,c,b).then(function(a){f.resolve(a),h(e)}),f.promise},i.prototype.validateEntity=function(a){var b=this,c=b.getModel();return c.validateEntity(b,a)},i.prototype.getAttachmentCollection=function(){return d.getCollection({operation:"GetAttachmentCollection",listName:this.getModel().list.guid,webURL:this.getModel().list.webURL,ID:this.id,filterNode:"Attachment"})},i.prototype.deleteAttachment=function(a){var b=this;return d.deleteAttachment({listItemId:b.id,url:a,listName:b.getModel().list.guid})},i.prototype.resolvePermissions=function(){return l(this.permMask)},i.prototype.getFieldVersionHistory=function(b){var e=a.defer(),f=[],g=this,h=g.getModel(),i=function(a){var b=_.findWhere(h.list.fields,{mappedName:a}),e={operation:"GetVersionCollection",webURL:c.defaultUrl,strlistID:h.list.guid,strlistItemID:g.id,strFieldName:b.internalName};f.push(d.getFieldVersionHistory(e,b))};if(b)_.isString(b)&&(b=[b]);else{var j=_.where(h.list.fields,{readOnly:!1});b=[],_.each(j,function(a){b.push(a.mappedName)})}return _.each(b,function(a){i(a)}),a.all(f).then(function(a){var b={};_.each(a,function(a){_.each(a,function(a){b[a.modified.toJSON()]||(b[a.modified.toJSON()]={}),_.extend(b[a.modified.toJSON()],a)})});var c=[];_.each(b,function(a,b){a.version=b,c.push(a)}),e.resolve(c)}),e.promise},k.prototype.execute=function(b){var c=this,e=c.getModel(),f=a.defer();if(c.negotiatingWithServer)return c.promise;c.negotiatingWithServer=!0;var g=_.isNull(c.lastRun),h={target:c.cache},i=_.extend({},h,b);return d.executeQuery(e,c,i).then(function(){g&&(c.initialized.resolve(i.target),c.negotiatingWithServer=!1),e.lastServerUpdate=new Date,f.resolve(i.target)}),c.promise=f.promise,f.promise},k.prototype.searchLocalCache=function(a,b){var c=this,d=c.getModel(),e={cacheName:c.name,localCache:c.cache},f=_.extend({},e,b);return d.searchLocalCache(a,f)},{ListItem:i,Model:g,Query:k,resolvePermissions:l}}]),angular.module("spAngular").service("queueService",function(){var a=0,b=function(){return a++,g(),a},c=function(){return a>0?(a--,g(),a):void 0},d=function(){return a=0,g(),a},e=[],f=function(a){e.push(a)},g=function(){angular.forEach(e,function(b){b(a)})};return{count:a,decrease:c,increase:b,registerObserverCallback:f,reset:d}}),angular.module("spAngular").factory("syncService",["$q","$timeout","$firebase","configService",function(a,b,c,d){function e(a,b){var e={};return e.updateQuery=b,e.changeNotifier=new Firebase(d.firebaseURL+"/changes/"+a.list.title),e.lastUpdate=c(e.changeNotifier),e.registerChange=function(){console.log("Change detected in "+a.list.title+" list.");var b=Firebase.ServerValue.TIMESTAMP;e.changeCount=0,e.lastUpdate.$set(b)},e.subscriptions=[],e.changeCount=0,e.processChanges=function(){e.changeCount>0&&_.each(e.subscriptions,function(a){console.log("Processing callback"),_.isFunction(a)&&a()}),e.changeCount+=1},e.throttleRequests=_.throttle(function(){return e.processChanges()},1e3,{leading:!1}),e.lastUpdate.$on("change",function(){e.throttleRequests()}),e.subscribeToChanges=function(a){-1===e.subscriptions.indexOf(a)&&e.subscriptions.push(a)},e}return{synchronizeData:e}}]),angular.module("spAngular").service("utilityService",function(){function a(a,n){var o;switch(n){case"DateTime":case"datetime":o=g(a);break;case"Lookup":o=j(a);break;case"User":o=h(a);break;case"LookupMulti":o=k(a);break;case"UserMulti":o=i(a);break;case"Boolean":o=f(a);break;case"Integer":o=d(a);break;case"Counter":o=d(a);break;case"MultiChoice":o=l(a);break;case"Currency":case"Number":case"float":o=e(a);break;case"Calc":o=m(a);break;case"JSON":o=b(a);break;default:o=c(a)}return o}function b(a){return JSON.parse(a)}function c(a){return a}function d(a){return parseInt(a,10)}function e(a){return parseFloat(a)}function f(a){return"0"===a||"False"===a?!1:!0}function g(a){return new Date(a.replace(/-/g,"/"))}function h(a){return 0===a.length?null:new r(a)}function i(a){if(0===a.length)return null;for(var b=[],c=a.split(";#"),d=0;d<c.length;d+=2){var e=h(c[d]+";#"+c[d+1]);b.push(e)}return b}function j(a){return 0===a.length?null:new q(a)}function k(a){if(0===a.length)return[];for(var b=[],c=a.split(";#"),d=0;d<c.length;d+=2){var e=j(c[d]+";#"+c[d+1]);b.push(e)}return b}function l(a){if(0===a.length)return[];for(var b=[],c=a.split(";#"),d=0;d<c.length;d++)0!==c[d].length&&b.push(c[d]);return b}function m(b){if(0===b.length)return null;var c=b.split(";#");return a(c[1],c[0])}function n(a){var b=a.split(";#");this.id=parseInt(b[0],10),this.value=b[1]}function o(a){return a.replace(/(?:^\w|[A-Z]|\b\w)/g,function(a,b){return 0==b?a.toLowerCase():a.toUpperCase()}).replace(/\s+/g,"")}function p(a){a.replace(/([A-Z])/g," $1").replace(/^./,function(a){return a.toUpperCase()})}function q(a){var b=new n(a);this.lookupId=b.id,this.lookupValue=b.value}function r(a){var b=this,c=new n(a),d=c.value.split(",#");1===d.length?(b.lookupId=c.id,b.lookupValue=c.value):(b.lookupId=c.id,b.lookupValue=d[0].replace(/(,,)/g,","),b.loginName=d[1].replace(/(,,)/g,","),b.email=d[2].replace(/(,,)/g,","),b.sipAddress=d[3].replace(/(,,)/g,","),b.title=d[4].replace(/(,,)/g,","))}function s(a){var b=a.getFullYear().toString(),c=(a.getMonth()+1).toString(),d=a.getDate().toString();return parseInt(b+(c[1]?c:"0"+c[0])+(d[1]?d:"0"+d[0]))}function t(a,b,c){if(!a||!b)return!1;c=c||new Date;var d=s(a),e=s(b),f=s(c);return f>=d&&e>=f}_.mixin({isDefined:function(a){return!_.isUndefined(a)}});var u=function(b,c){var d,e=$.extend({},{mapping:{},includeAllAttrs:!1,removeOws:!0},c),f=[];return _.each(b,function(b){var c={},g=b.attributes;for(_.each(e.mapping,function(a){c[a.mappedName]=""}),d=0;d<g.length;d++){var h=g[d].name,i=e.mapping[h],j="undefined"!=typeof i?i.mappedName:e.removeOws?h.split("ows_")[1]:h,k="undefined"!=typeof i?i.objectType:void 0;(e.includeAllAttrs||void 0!==i)&&(c[j]=a(g[d].value,k))}f.push(c)}),f};return{attrToJson:a,dateWithinRange:t,fromCamelCase:p,lookupToJsonObject:j,SplitIndex:n,toCamelCase:o,xmlToJson:u}});